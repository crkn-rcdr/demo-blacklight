function memoize(e){let t=null;const memoized=()=>{null==t&&(t=e());return t};return memoized}function without(e,t){return e.filter((e=>e!==t))}function union(e,t){const r=new Set;const insertItem=e=>r.add(e);e.forEach(insertItem);t.forEach(insertItem);const n=[];r.forEach((e=>n.push(e)));return n}class EnterLeaveCounter{enter(e){const t=this.entered.length;const isNodeEntered=t=>this.isNodeInDocument(t)&&(!t.contains||t.contains(e));this.entered=union(this.entered.filter(isNodeEntered),[e]);return 0===t&&this.entered.length>0}leave(e){const t=this.entered.length;this.entered=without(this.entered.filter(this.isNodeInDocument),e);return t>0&&0===this.entered.length}reset(){this.entered=[]}constructor(e){this.entered=[];this.isNodeInDocument=e}}class NativeDragSource{initializeExposedProperties(){Object.keys(this.config.exposeProperties).forEach((e=>{Object.defineProperty(this.item,e,{configurable:true,enumerable:true,get(){console.warn(`Browser doesn't allow reading "${e}" until the drop event.`);return null}})}))}loadDataTransfer(e){if(e){const t={};Object.keys(this.config.exposeProperties).forEach((r=>{const n=this.config.exposeProperties[r];null!=n&&(t[r]={value:n(e,this.config.matchesTypes),configurable:true,enumerable:true})}));Object.defineProperties(this.item,t)}}canDrag(){return true}beginDrag(){return this.item}isDragging(e,t){return t===e.getSourceId()}endDrag(){}constructor(e){this.config=e;this.item={};this.initializeExposedProperties()}}const e="__NATIVE_FILE__";const t="__NATIVE_URL__";const r="__NATIVE_TEXT__";const n="__NATIVE_HTML__";var s=Object.freeze(Object.defineProperty({__proto__:null,FILE:e,URL:t,TEXT:r,HTML:n},Symbol.toStringTag,{value:"Module"}));function getDataFromDataTransfer(e,t,r){const n=t.reduce(((t,r)=>t||e.getData(r)),"");return null!=n?n:r}const i={[e]:{exposeProperties:{files:e=>Array.prototype.slice.call(e.files),items:e=>e.items,dataTransfer:e=>e},matchesTypes:["Files"]},[n]:{exposeProperties:{html:(e,t)=>getDataFromDataTransfer(e,t,""),dataTransfer:e=>e},matchesTypes:["Html","text/html"]},[t]:{exposeProperties:{urls:(e,t)=>getDataFromDataTransfer(e,t,"").split("\n"),dataTransfer:e=>e},matchesTypes:["Url","text/uri-list"]},[r]:{exposeProperties:{text:(e,t)=>getDataFromDataTransfer(e,t,""),dataTransfer:e=>e},matchesTypes:["Text","text/plain"]}};function createNativeDragSource(e,t){const r=i[e];if(!r)throw new Error(`native type ${e} has no configuration`);const n=new NativeDragSource(r);n.loadDataTransfer(t);return n}function matchNativeItemType(e){if(!e)return null;const t=Array.prototype.slice.call(e.types||[]);return Object.keys(i).filter((e=>{const r=i[e];return!!(null===r||void 0===r?void 0:r.matchesTypes)&&r.matchesTypes.some((e=>t.indexOf(e)>-1))}))[0]||null}const o=memoize((()=>/firefox/i.test(navigator.userAgent)));const a=memoize((()=>Boolean(window.safari)));class MonotonicInterpolant{interpolate(e){const{xs:t,ys:r,c1s:n,c2s:s,c3s:i}=this;let o=t.length-1;if(e===t[o])return r[o];let a=0;let d=i.length-1;let c;while(a<=d){c=Math.floor(.5*(a+d));const n=t[c];if(n<e)a=c+1;else{if(!(n>e))return r[c];d=c-1}}o=Math.max(0,d);const h=e-t[o];const u=h*h;return r[o]+n[o]*h+s[o]*u+i[o]*h*u}constructor(e,t){const{length:r}=e;const n=[];for(let e=0;e<r;e++)n.push(e);n.sort(((t,r)=>e[t]<e[r]?-1:1));const s=[];const i=[];const o=[];let a;let d;for(let n=0;n<r-1;n++){a=e[n+1]-e[n];d=t[n+1]-t[n];i.push(a);s.push(d);o.push(d/a)}const c=[o[0]];for(let e=0;e<i.length-1;e++){const t=o[e];const r=o[e+1];if(t*r<=0)c.push(0);else{a=i[e];const n=i[e+1];const s=a+n;c.push(3*s/((s+n)/t+(s+a)/r))}}c.push(o[o.length-1]);const h=[];const u=[];let g;for(let e=0;e<c.length-1;e++){g=o[e];const t=c[e];const r=1/i[e];const n=t+c[e+1]-g-g;h.push((g-t-n)*r);u.push(n*r*r)}this.xs=e;this.ys=t;this.c1s=c;this.c2s=h;this.c3s=u}}const d=1;function getNodeClientOffset(e){const t=e.nodeType===d?e:e.parentElement;if(!t)return null;const{top:r,left:n}=t.getBoundingClientRect();return{x:n,y:r}}function getEventClientOffset(e){return{x:e.clientX,y:e.clientY}}function isImageNode(e){var t;return"IMG"===e.nodeName&&(o()||!(null===(t=document.documentElement)||void 0===t?void 0:t.contains(e)))}function getDragPreviewSize(e,t,r,n){let s=e?t.width:r;let i=e?t.height:n;if(a()&&e){i/=window.devicePixelRatio;s/=window.devicePixelRatio}return{dragPreviewWidth:s,dragPreviewHeight:i}}function getDragPreviewOffset(e,t,r,n,s){const i=isImageNode(t);const o=i?e:t;const d=getNodeClientOffset(o);const c={x:r.x-d.x,y:r.y-d.y};const{offsetWidth:h,offsetHeight:u}=e;const{anchorX:g,anchorY:l}=n;const{dragPreviewWidth:v,dragPreviewHeight:f}=getDragPreviewSize(i,t,h,u);const calculateYOffset=()=>{const e=new MonotonicInterpolant([0,.5,1],[c.y,c.y/u*f,c.y+f-u]);let t=e.interpolate(l);a()&&i&&(t+=(window.devicePixelRatio-1)*f);return t};const calculateXOffset=()=>{const e=new MonotonicInterpolant([0,.5,1],[c.x,c.x/h*v,c.x+v-h]);return e.interpolate(g)};const{offsetX:p,offsetY:m}=s;const D=0===p||p;const T=0===m||m;return{x:D?p:calculateXOffset(),y:T?m:calculateYOffset()}}class OptionsReader{get window(){return this.globalContext?this.globalContext:"undefined"!==typeof window?window:void 0}get document(){var e;return(null===(e=this.globalContext)||void 0===e?void 0:e.document)?this.globalContext.document:this.window?this.window.document:void 0}get rootElement(){var e;return(null===(e=this.optionsArgs)||void 0===e?void 0:e.rootElement)||this.window}constructor(e,t){this.ownerDocument=null;this.globalContext=e;this.optionsArgs=t}}function _defineProperty(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:true,configurable:true,writable:true}):e[t]=r;return e}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};var n=Object.keys(r);"function"===typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))));n.forEach((function(t){_defineProperty(e,t,r[t])}))}return e}class HTML5BackendImpl{profile(){var e,t;return{sourcePreviewNodes:this.sourcePreviewNodes.size,sourcePreviewNodeOptions:this.sourcePreviewNodeOptions.size,sourceNodeOptions:this.sourceNodeOptions.size,sourceNodes:this.sourceNodes.size,dragStartSourceIds:(null===(e=this.dragStartSourceIds)||void 0===e?void 0:e.length)||0,dropTargetIds:this.dropTargetIds.length,dragEnterTargetIds:this.dragEnterTargetIds.length,dragOverTargetIds:(null===(t=this.dragOverTargetIds)||void 0===t?void 0:t.length)||0}}get window(){return this.options.window}get document(){return this.options.document}get rootElement(){return this.options.rootElement}setup(){const e=this.rootElement;if(void 0!==e){if(e.__isReactDndBackendSetUp)throw new Error("Cannot have two HTML5 backends at the same time.");e.__isReactDndBackendSetUp=true;this.addEventListeners(e)}}teardown(){const e=this.rootElement;if(void 0!==e){e.__isReactDndBackendSetUp=false;this.removeEventListeners(this.rootElement);this.clearCurrentDragSourceNode();if(this.asyncEndDragFrameId){var t;null===(t=this.window)||void 0===t?void 0:t.cancelAnimationFrame(this.asyncEndDragFrameId)}}}connectDragPreview(e,t,r){this.sourcePreviewNodeOptions.set(e,r);this.sourcePreviewNodes.set(e,t);return()=>{this.sourcePreviewNodes.delete(e);this.sourcePreviewNodeOptions.delete(e)}}connectDragSource(e,t,r){this.sourceNodes.set(e,t);this.sourceNodeOptions.set(e,r);const handleDragStart=t=>this.handleDragStart(t,e);const handleSelectStart=e=>this.handleSelectStart(e);t.setAttribute("draggable","true");t.addEventListener("dragstart",handleDragStart);t.addEventListener("selectstart",handleSelectStart);return()=>{this.sourceNodes.delete(e);this.sourceNodeOptions.delete(e);t.removeEventListener("dragstart",handleDragStart);t.removeEventListener("selectstart",handleSelectStart);t.setAttribute("draggable","false")}}connectDropTarget(e,t){const handleDragEnter=t=>this.handleDragEnter(t,e);const handleDragOver=t=>this.handleDragOver(t,e);const handleDrop=t=>this.handleDrop(t,e);t.addEventListener("dragenter",handleDragEnter);t.addEventListener("dragover",handleDragOver);t.addEventListener("drop",handleDrop);return()=>{t.removeEventListener("dragenter",handleDragEnter);t.removeEventListener("dragover",handleDragOver);t.removeEventListener("drop",handleDrop)}}addEventListeners(e){if(e.addEventListener){e.addEventListener("dragstart",this.handleTopDragStart);e.addEventListener("dragstart",this.handleTopDragStartCapture,true);e.addEventListener("dragend",this.handleTopDragEndCapture,true);e.addEventListener("dragenter",this.handleTopDragEnter);e.addEventListener("dragenter",this.handleTopDragEnterCapture,true);e.addEventListener("dragleave",this.handleTopDragLeaveCapture,true);e.addEventListener("dragover",this.handleTopDragOver);e.addEventListener("dragover",this.handleTopDragOverCapture,true);e.addEventListener("drop",this.handleTopDrop);e.addEventListener("drop",this.handleTopDropCapture,true)}}removeEventListeners(e){if(e.removeEventListener){e.removeEventListener("dragstart",this.handleTopDragStart);e.removeEventListener("dragstart",this.handleTopDragStartCapture,true);e.removeEventListener("dragend",this.handleTopDragEndCapture,true);e.removeEventListener("dragenter",this.handleTopDragEnter);e.removeEventListener("dragenter",this.handleTopDragEnterCapture,true);e.removeEventListener("dragleave",this.handleTopDragLeaveCapture,true);e.removeEventListener("dragover",this.handleTopDragOver);e.removeEventListener("dragover",this.handleTopDragOverCapture,true);e.removeEventListener("drop",this.handleTopDrop);e.removeEventListener("drop",this.handleTopDropCapture,true)}}getCurrentSourceNodeOptions(){const e=this.monitor.getSourceId();const t=this.sourceNodeOptions.get(e);return _objectSpread({dropEffect:this.altKeyPressed?"copy":"move"},t||{})}getCurrentDropEffect(){return this.isDraggingNativeItem()?"copy":this.getCurrentSourceNodeOptions().dropEffect}getCurrentSourcePreviewNodeOptions(){const e=this.monitor.getSourceId();const t=this.sourcePreviewNodeOptions.get(e);return _objectSpread({anchorX:.5,anchorY:.5,captureDraggingState:false},t||{})}isDraggingNativeItem(){const e=this.monitor.getItemType();return Object.keys(s).some((t=>s[t]===e))}beginDragNativeItem(e,t){this.clearCurrentDragSourceNode();this.currentNativeSource=createNativeDragSource(e,t);this.currentNativeHandle=this.registry.addSource(e,this.currentNativeSource);this.actions.beginDrag([this.currentNativeHandle])}setCurrentDragSourceNode(e){this.clearCurrentDragSourceNode();this.currentDragSourceNode=e;const t=1e3;this.mouseMoveTimeoutTimer=setTimeout((()=>{var e;return null===(e=this.rootElement)||void 0===e?void 0:e.addEventListener("mousemove",this.endDragIfSourceWasRemovedFromDOM,true)}),t)}clearCurrentDragSourceNode(){if(this.currentDragSourceNode){this.currentDragSourceNode=null;if(this.rootElement){var e;null===(e=this.window)||void 0===e?void 0:e.clearTimeout(this.mouseMoveTimeoutTimer||void 0);this.rootElement.removeEventListener("mousemove",this.endDragIfSourceWasRemovedFromDOM,true)}this.mouseMoveTimeoutTimer=null;return true}return false}handleDragStart(e,t){if(!e.defaultPrevented){this.dragStartSourceIds||(this.dragStartSourceIds=[]);this.dragStartSourceIds.unshift(t)}}handleDragEnter(e,t){this.dragEnterTargetIds.unshift(t)}handleDragOver(e,t){null===this.dragOverTargetIds&&(this.dragOverTargetIds=[]);this.dragOverTargetIds.unshift(t)}handleDrop(e,t){this.dropTargetIds.unshift(t)}constructor(e,t,r){this.sourcePreviewNodes=new Map;this.sourcePreviewNodeOptions=new Map;this.sourceNodes=new Map;this.sourceNodeOptions=new Map;this.dragStartSourceIds=null;this.dropTargetIds=[];this.dragEnterTargetIds=[];this.currentNativeSource=null;this.currentNativeHandle=null;this.currentDragSourceNode=null;this.altKeyPressed=false;this.mouseMoveTimeoutTimer=null;this.asyncEndDragFrameId=null;this.dragOverTargetIds=null;this.lastClientOffset=null;this.hoverRafId=null;this.getSourceClientOffset=e=>{const t=this.sourceNodes.get(e);return t&&getNodeClientOffset(t)||null};this.endDragNativeItem=()=>{if(this.isDraggingNativeItem()){this.actions.endDrag();this.currentNativeHandle&&this.registry.removeSource(this.currentNativeHandle);this.currentNativeHandle=null;this.currentNativeSource=null}};this.isNodeInDocument=e=>Boolean(e&&this.document&&this.document.body&&this.document.body.contains(e));this.endDragIfSourceWasRemovedFromDOM=()=>{const e=this.currentDragSourceNode;if(null!=e&&!this.isNodeInDocument(e)){this.clearCurrentDragSourceNode()&&this.monitor.isDragging()&&this.actions.endDrag();this.cancelHover()}};this.scheduleHover=e=>{null===this.hoverRafId&&"undefined"!==typeof requestAnimationFrame&&(this.hoverRafId=requestAnimationFrame((()=>{this.monitor.isDragging()&&this.actions.hover(e||[],{clientOffset:this.lastClientOffset});this.hoverRafId=null})))};this.cancelHover=()=>{if(null!==this.hoverRafId&&"undefined"!==typeof cancelAnimationFrame){cancelAnimationFrame(this.hoverRafId);this.hoverRafId=null}};this.handleTopDragStartCapture=()=>{this.clearCurrentDragSourceNode();this.dragStartSourceIds=[]};this.handleTopDragStart=e=>{if(e.defaultPrevented)return;const{dragStartSourceIds:t}=this;this.dragStartSourceIds=null;const r=getEventClientOffset(e);if(this.monitor.isDragging()){this.actions.endDrag();this.cancelHover()}this.actions.beginDrag(t||[],{publishSource:false,getSourceClientOffset:this.getSourceClientOffset,clientOffset:r});const{dataTransfer:n}=e;const s=matchNativeItemType(n);if(this.monitor.isDragging()){if(n&&"function"===typeof n.setDragImage){const e=this.monitor.getSourceId();const t=this.sourceNodes.get(e);const s=this.sourcePreviewNodes.get(e)||t;if(s){const{anchorX:e,anchorY:i,offsetX:o,offsetY:a}=this.getCurrentSourcePreviewNodeOptions();const d={anchorX:e,anchorY:i};const c={offsetX:o,offsetY:a};const h=getDragPreviewOffset(t,s,r,d,c);n.setDragImage(s,h.x,h.y)}}try{null===n||void 0===n?void 0:n.setData("application/json",{})}catch(e){}this.setCurrentDragSourceNode(e.target);const{captureDraggingState:t}=this.getCurrentSourcePreviewNodeOptions();t?this.actions.publishDragSource():setTimeout((()=>this.actions.publishDragSource()),0)}else if(s)this.beginDragNativeItem(s);else{if(n&&!n.types&&(e.target&&!e.target.hasAttribute||!e.target.hasAttribute("draggable")))return;e.preventDefault()}};this.handleTopDragEndCapture=()=>{this.clearCurrentDragSourceNode()&&this.monitor.isDragging()&&this.actions.endDrag();this.cancelHover()};this.handleTopDragEnterCapture=e=>{this.dragEnterTargetIds=[];if(this.isDraggingNativeItem()){var t;null===(t=this.currentNativeSource)||void 0===t?void 0:t.loadDataTransfer(e.dataTransfer)}const r=this.enterLeaveCounter.enter(e.target);if(!r||this.monitor.isDragging())return;const{dataTransfer:n}=e;const s=matchNativeItemType(n);s&&this.beginDragNativeItem(s,n)};this.handleTopDragEnter=e=>{const{dragEnterTargetIds:t}=this;this.dragEnterTargetIds=[];if(!this.monitor.isDragging())return;this.altKeyPressed=e.altKey;t.length>0&&this.actions.hover(t,{clientOffset:getEventClientOffset(e)});const r=t.some((e=>this.monitor.canDropOnTarget(e)));if(r){e.preventDefault();e.dataTransfer&&(e.dataTransfer.dropEffect=this.getCurrentDropEffect())}};this.handleTopDragOverCapture=e=>{this.dragOverTargetIds=[];if(this.isDraggingNativeItem()){var t;null===(t=this.currentNativeSource)||void 0===t?void 0:t.loadDataTransfer(e.dataTransfer)}};this.handleTopDragOver=e=>{const{dragOverTargetIds:t}=this;this.dragOverTargetIds=[];if(!this.monitor.isDragging()){e.preventDefault();e.dataTransfer&&(e.dataTransfer.dropEffect="none");return}this.altKeyPressed=e.altKey;this.lastClientOffset=getEventClientOffset(e);this.scheduleHover(t);const r=(t||[]).some((e=>this.monitor.canDropOnTarget(e)));if(r){e.preventDefault();e.dataTransfer&&(e.dataTransfer.dropEffect=this.getCurrentDropEffect())}else if(this.isDraggingNativeItem())e.preventDefault();else{e.preventDefault();e.dataTransfer&&(e.dataTransfer.dropEffect="none")}};this.handleTopDragLeaveCapture=e=>{this.isDraggingNativeItem()&&e.preventDefault();const t=this.enterLeaveCounter.leave(e.target);if(t){this.isDraggingNativeItem()&&setTimeout((()=>this.endDragNativeItem()),0);this.cancelHover()}};this.handleTopDropCapture=e=>{this.dropTargetIds=[];if(this.isDraggingNativeItem()){var t;e.preventDefault();null===(t=this.currentNativeSource)||void 0===t?void 0:t.loadDataTransfer(e.dataTransfer)}else matchNativeItemType(e.dataTransfer)&&e.preventDefault();this.enterLeaveCounter.reset()};this.handleTopDrop=e=>{const{dropTargetIds:t}=this;this.dropTargetIds=[];this.actions.hover(t,{clientOffset:getEventClientOffset(e)});this.actions.drop({dropEffect:this.getCurrentDropEffect()});this.isDraggingNativeItem()?this.endDragNativeItem():this.monitor.isDragging()&&this.actions.endDrag();this.cancelHover()};this.handleSelectStart=e=>{const t=e.target;if("function"===typeof t.dragDrop&&"INPUT"!==t.tagName&&"SELECT"!==t.tagName&&"TEXTAREA"!==t.tagName&&!t.isContentEditable){e.preventDefault();t.dragDrop()}};this.options=new OptionsReader(t,r);this.actions=e.getActions();this.monitor=e.getMonitor();this.registry=e.getRegistry();this.enterLeaveCounter=new EnterLeaveCounter(this.isNodeInDocument)}}let c;function getEmptyImage(){if(!c){c=new Image;c.src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="}return c}const h=function createBackend(e,t,r){return new HTML5BackendImpl(e,t,r)};export{h as HTML5Backend,s as NativeTypes,getEmptyImage};

